#!/usr/bin/env ruby
require 'optparse'
require 'morpheus/cli'
require 'morpheus/rest_client'
require 'morpheus/cli/cli_registry'
require 'morpheus/cli/error_handler'

# short circuit version switch
if ARGV[0] == '-v' && ARGV.size == 1
  version = Morpheus::Cli::VERSION
  puts version
  exit 0
end

# handle global options
args = ARGV
# set global log level to debug (print stack trace for bubbled exceptions)
if args.find {|arg| arg == '-V' || arg == '--debug'}
  Morpheus::Logging.set_log_level(Morpheus::Logging::Logger::DEBUG)
  args = args.reject {|arg| arg == '-V' && arg == '--debug'}
end

# JD: figure out what to do with --insecure option
if args.find {|arg| arg == '--insecure'}
  Morpheus::RestClient.enable_ssl_verification = false
  args = args.find_all {|arg| arg != '--insecure'}
end

# all commands should be registered commands
if Morpheus::Cli::CliRegistry.has_command?(args[0])
  begin
    Morpheus::Cli::CliRegistry.exec(args[0], args[1..-1])
  rescue => e
    Morpheus::Cli::ErrorHandler.new.handle_error(e)
    exit 1
  end
  exit 0
else
  puts "Usage: morpheus [command] [options]"
  puts "\nCommands:"
  Morpheus::Cli::CliRegistry.all.each {|cmd,klass|
    puts "\t#{cmd.to_s}"
  }
  puts ""
  exit 127
end
